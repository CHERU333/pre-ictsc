name: ictsc-evpn

topology:
  nodes:
    rt1:
      kind: linux
      image: frrouting/frr:latest
      binds:
        - ./broken/rt1.frr.conf:/etc/frr/frr.conf
      exec:
        - bash -lc "echo '#!/bin/bash' > /usr/local/bin/start-frr.sh"
        - bash -lc "echo 'sed -i \"s/^bgpd=.*/bgpd=yes/\" /etc/frr/daemons || true' >> /usr/local/bin/start-frr.sh"
        - bash -lc "echo 'sed -i \"s/^zebra=.*/zebra=yes/\" /etc/frr/daemons || true' >> /usr/local/bin/start-frr.sh"
        - bash -lc "echo 'echo service integrated-vtysh-config > /etc/frr/vtysh.conf' >> /usr/local/bin/start-frr.sh"
        - bash -lc "echo 'pkill -f watchfrr || true' >> /usr/local/bin/start-frr.sh"
        - bash -lc "echo '/usr/lib/frr/watchfrr -d zebra bgpd >/var/log/frr_start.log 2>&1 &' >> /usr/local/bin/start-frr.sh"
        - bash -lc "chmod +x /usr/local/bin/start-frr.sh && nohup /usr/local/bin/start-frr.sh >/dev/null 2>&1 &"

    rt2:
      kind: linux
      image: frrouting/frr:latest
      binds:
        - ./broken/rt2.frr.conf:/etc/frr/frr.conf
      exec:
        - bash -lc "echo '#!/bin/bash' > /usr/local/bin/start-frr.sh"
        - bash -lc "echo 'sed -i \"s/^bgpd=.*/bgpd=yes/\" /etc/frr/daemons || true' >> /usr/local/bin/start-frr.sh"
        - bash -lc "echo 'sed -i \"s/^zebra=.*/zebra=yes/\" /etc/frr/daemons || true' >> /usr/local/bin/start-frr.sh"
        - bash -lc "echo 'echo service integrated-vtysh-config > /etc/frr/vtysh.conf' >> /usr/local/bin/start-frr.sh"
        - bash -lc "echo 'pkill -f watchfrr || true' >> /usr/local/bin/start-frr.sh"
        - bash -lc "echo '/usr/lib/frr/watchfrr -d zebra bgpd >/var/log/frr_start.log 2>&1 &' >> /usr/local/bin/start-frr.sh"
        - bash -lc "chmod +x /usr/local/bin/start-frr.sh && nohup /usr/local/bin/start-frr.sh >/dev/null 2>&1 &"

    rt3:
      kind: linux
      image: frrouting/frr:latest
      binds:
        - ./broken/rt3.frr.conf:/etc/frr/frr.conf
      exec:
        - bash -lc "echo '#!/bin/bash' > /usr/local/bin/start-frr.sh"
        - bash -lc "echo 'sed -i \"s/^bgpd=.*/bgpd=yes/\" /etc/frr/daemons || true' >> /usr/local/bin/start-frr.sh"
        - bash -lc "echo 'sed -i \"s/^zebra=.*/zebra=yes/\" /etc/frr/daemons || true' >> /usr/local/bin/start-frr.sh"
        - bash -lc "echo 'echo service integrated-vtysh-config > /etc/frr/vtysh.conf' >> /usr/local/bin/start-frr.sh"
        - bash -lc "echo 'pkill -f watchfrr || true' >> /usr/local/bin/start-frr.sh"
        - bash -lc "echo '/usr/lib/frr/watchfrr -d zebra bgpd >/var/log/frr_start.log 2>&1 &' >> /usr/local/bin/start-frr.sh"
        - bash -lc "chmod +x /usr/local/bin/start-frr.sh && nohup /usr/local/bin/start-frr.sh >/dev/null 2>&1 &"

    sv-1:
      kind: linux
      image: ictsc/sv1:latest
      binds:
        - ./servers/sv-1/client.py:/home/user/client.py
      exec:
        - bash -lc "ip link set eth1 up; ip link add link eth1 name eth1.100 type vlan id 100; ip addr add 192.168.20.1/27 dev eth1.100; ip link set eth1.100 up"

    sv-2:
      kind: linux
      image: ictsc/sv2:latest
      exec:
        - bash -lc "ip link set eth1 up; ip addr add 192.168.20.2/27 dev eth1; service apache2 start"

  links:
    - endpoints: ["rt1:eth2","rt2:eth1"]
    - endpoints: ["rt3:eth1","rt2:eth2"]
    - endpoints: ["sv-1:eth1","rt1:eth1"]
    - endpoints: ["sv-2:eth1","rt3:eth2"]
